# ç®¡ç†å‘˜ä¿®æ”¹è®¢å•é‡‘é¢åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°ç®¡ç†å‘˜ä¿®æ”¹è®¢å•é‡‘é¢åŠŸèƒ½ï¼Œåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æœªæ”¯ä»˜è®¢å•çš„é‡‘é¢ã€‚

## âœ… å®ç°å®Œæˆ

### åç«¯å®ç°

#### 1. æ•°æ®åº“å±‚
**æ–‡ä»¶**: `anyuyinian/db/dao/order_interface.go`
**æ–°å¢æ–¹æ³•**: `UpdateOrderAmount(id int32, newAmount float64) error`

**æ–‡ä»¶**: `anyuyinian/db/dao/order_dao.go`
**å®ç°æ–¹æ³•**: æ›´æ–°è®¢å•æ€»é‡‘é¢å’Œä¿®æ”¹æ—¶é—´

#### 2. æœåŠ¡å±‚
**æ–‡ä»¶**: `anyuyinian/service/admin_service.go`
**æ–°å¢å†…å®¹**:
- `UpdateOrderAmountRequest` ç»“æ„ä½“
- `UpdateOrderAmountHandler` å¤„ç†å™¨

**åŠŸèƒ½ç‰¹æ€§**:
- æƒé™éªŒè¯ï¼šåªæœ‰è¶…çº§ç®¡ç†å‘˜ï¼ˆadminLevel = 2ï¼‰å¯ä»¥ä¿®æ”¹
- è®¢å•çŠ¶æ€éªŒè¯ï¼šåªæœ‰æœªæ”¯ä»˜è®¢å•å¯ä»¥ä¿®æ”¹
- å‚æ•°éªŒè¯ï¼šæ–°é‡‘é¢å¿…é¡»å¤§äº0
- å®Œæ•´æ—¥å¿—è®°å½•

#### 3. è·¯ç”±é…ç½®
**æ–‡ä»¶**: `anyuyinian/main.go`
**æ–°å¢è·¯ç”±**: `/api/admin/order/update-amount`

### å‰ç«¯å®ç°

#### 1. é¡µé¢æ˜¾ç¤º
**æ–‡ä»¶**: `miniprogram/pages/admin/orders.wxml`
**æ–°å¢å†…å®¹**:
- ä¿®æ”¹é‡‘é¢æŒ‰é’®ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ä¸”è®¢å•æœªæ”¯ä»˜æ—¶æ˜¾ç¤ºï¼‰

#### 2. äº¤äº’é€»è¾‘
**æ–‡ä»¶**: `miniprogram/pages/admin/orders.js`
**æ–°å¢åŠŸèƒ½**:
- `onEditAmount`: æ˜¾ç¤ºä¿®æ”¹é‡‘é¢å¼¹çª—ï¼ˆç®€æ´çš„è¾“å…¥æ¡†ï¼‰
- `updateOrderAmount`: è°ƒç”¨åç«¯APIä¿®æ”¹é‡‘é¢

#### 3. æ ·å¼è®¾è®¡
**æ–‡ä»¶**: `miniprogram/pages/admin/orders.wxss`
**æ–°å¢æ ·å¼**:
- `.order-actions`: æ“ä½œæŒ‰é’®å®¹å™¨
- `.edit-amount-btn`: ä¿®æ”¹é‡‘é¢æŒ‰é’®æ ·å¼

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æƒé™æ§åˆ¶
```go
// åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è®¢å•é‡‘é¢
if admin.AdminLevel != 2 {
    return "åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è®¢å•é‡‘é¢"
}
```

### 2. è®¢å•çŠ¶æ€éªŒè¯
```go
// åªæœ‰æœªæ”¯ä»˜çš„è®¢å•å¯ä»¥ä¿®æ”¹é‡‘é¢
if order.Status != 0 || order.PayStatus != 0 {
    return "åªæœ‰æœªæ”¯ä»˜çš„è®¢å•å¯ä»¥ä¿®æ”¹é‡‘é¢"
}
```

### 3. å‚æ•°éªŒè¯
```go
// éªŒè¯æ–°é‡‘é¢
if req.NewAmount <= 0 {
    return "æ–°é‡‘é¢å¿…é¡»å¤§äº0"
}
```

## ğŸ“‹ APIæ¥å£

### ä¿®æ”¹è®¢å•é‡‘é¢æ¥å£
- **URL**: `POST /api/admin/order/update-amount`
- **å‚æ•°**: `adminUserId` (æŸ¥è¯¢å‚æ•°)
- **è¯·æ±‚ä½“**:
```json
{
  "orderId": 1,
  "newAmount": 399.00,
  "reason": "ç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹"
}
```
- **å“åº”**:
```json
{
  "code": 0,
  "data": {
    "orderId": 1,
    "orderNo": "ORDER20241220001",
    "oldAmount": 299.00,
    "newAmount": 399.00,
    "reason": "ç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹",
    "adminId": "anyuyinian"
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
- âœ… `tests/backend/test_update_order_amount.sh` - ä¿®æ”¹è®¢å•é‡‘é¢æµ‹è¯•

### æµ‹è¯•åœºæ™¯
1. **æƒé™éªŒè¯**: éè¶…çº§ç®¡ç†å‘˜æ— æ³•ä¿®æ”¹
2. **è®¢å•çŠ¶æ€éªŒè¯**: å·²æ”¯ä»˜è®¢å•æ— æ³•ä¿®æ”¹
3. **å‚æ•°éªŒè¯**: æ— æ•ˆé‡‘é¢æ— æ³•ä¿®æ”¹
4. **æˆåŠŸä¿®æ”¹**: æ­£å¸¸ä¿®æ”¹æµç¨‹

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
- âœ… `anyuyinian/db/dao/order_interface.go` - æ·»åŠ æ¥å£å®šä¹‰
- âœ… `anyuyinian/db/dao/order_dao.go` - å®ç°æ›´æ–°æ–¹æ³•
- âœ… `anyuyinian/service/admin_service.go` - æ·»åŠ å¤„ç†å™¨
- âœ… `anyuyinian/main.go` - æ·»åŠ è·¯ç”±é…ç½®

### å‰ç«¯æ–‡ä»¶
- âœ… `miniprogram/pages/admin/orders.wxml` - æ·»åŠ ä¿®æ”¹æŒ‰é’®
- âœ… `miniprogram/pages/admin/orders.js` - æ·»åŠ äº¤äº’é€»è¾‘
- âœ… `miniprogram/pages/admin/orders.wxss` - æ·»åŠ æŒ‰é’®æ ·å¼

### æµ‹è¯•æ–‡ä»¶
- âœ… `tests/backend/test_update_order_amount.sh` - æµ‹è¯•è„šæœ¬

## ğŸš€ éƒ¨ç½²çŠ¶æ€

### åç«¯éƒ¨ç½²
- âœ… ä»£ç å®ç°å®Œæˆ
- âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡
- âœ… è·¯ç”±é…ç½®å®Œæˆ
- âœ… æƒé™æ§åˆ¶å®ç°

### å‰ç«¯éƒ¨ç½²
- âœ… é¡µé¢ä¿®æ”¹å®Œæˆ
- âœ… äº¤äº’é€»è¾‘å®ç°
- âœ… æ ·å¼è®¾è®¡å®Œæˆ

## âš ï¸ å®‰å…¨è€ƒè™‘

### 1. æƒé™æ§åˆ¶
- åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è®¢å•é‡‘é¢
- å‰ç«¯ä¹Ÿè¿›è¡Œæƒé™éªŒè¯

### 2. çŠ¶æ€éªŒè¯
- åªæœ‰æœªæ”¯ä»˜è®¢å•å¯ä»¥ä¿®æ”¹
- é˜²æ­¢å·²æ”¯ä»˜è®¢å•è¢«ä¿®æ”¹

### 3. å‚æ•°éªŒè¯
- æ–°é‡‘é¢å¿…é¡»å¤§äº0
- è®¢å•IDå¿…é¡»æœ‰æ•ˆ

### 4. æ—¥å¿—è®°å½•
- è®°å½•æ‰€æœ‰ä¿®æ”¹æ“ä½œ
- åŒ…å«ä¿®æ”¹å‰åçš„é‡‘é¢ä¿¡æ¯

## ğŸ”„ ä½¿ç”¨æµç¨‹

### 1. ç®¡ç†å‘˜ç™»å½•
- ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•

### 2. æŸ¥çœ‹è®¢å•
- è¿›å…¥è®¢å•ç®¡ç†é¡µé¢
- æŸ¥çœ‹æœªæ”¯ä»˜è®¢å•

### 3. ä¿®æ”¹é‡‘é¢
- ç‚¹å‡»"ä¿®æ”¹é‡‘é¢"æŒ‰é’®
- è¾“å…¥æ–°é‡‘é¢
- ç¡®è®¤ä¿®æ”¹

### 4. éªŒè¯ç»“æœ
- æŸ¥çœ‹ä¿®æ”¹åçš„è®¢å•é‡‘é¢
- ç¡®è®¤ä¿®æ”¹æˆåŠŸ

## âœ… åŠŸèƒ½å®ŒæˆçŠ¶æ€

- âœ… åç«¯APIå®ç°å®Œæˆ
- âœ… å‰ç«¯ç•Œé¢å®ç°å®Œæˆ
- âœ… æƒé™æ§åˆ¶å®ç°å®Œæˆ
- âœ… å‚æ•°éªŒè¯å®ç°å®Œæˆ
- âœ… æµ‹è¯•è„šæœ¬å‡†å¤‡å®Œæˆ
- âœ… ä»£ç ç¼–è¯‘é€šè¿‡
- âœ… äº‹ä»¶å†’æ³¡é—®é¢˜ä¿®å¤å®Œæˆ

**ç®¡ç†å‘˜ä¿®æ”¹è®¢å•é‡‘é¢åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶å¯ä»¥éƒ¨ç½²ä½¿ç”¨ï¼**

## ğŸ”§ é—®é¢˜ä¿®å¤

### äº‹ä»¶å†’æ³¡é—®é¢˜ä¿®å¤
**é—®é¢˜æè¿°**: ç‚¹å‡»"ä¿®æ”¹é‡‘é¢"æŒ‰é’®æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘è®¢å•è¯¦æƒ…é¡µè·³è½¬ï¼Œæç¤º"è¯·ä½¿ç”¨è®¢å•å·æŸ¥çœ‹è¯¦æƒ…"

**è§£å†³æ–¹æ¡ˆ**:
1. **é‡æ„WXMLç»“æ„**: å°†è®¢å•å†…å®¹å’Œæ“ä½œæŒ‰é’®åˆ†ç¦»
   - è®¢å•å†…å®¹åŒ…è£…åœ¨ `order-content-wrapper` ä¸­ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶
   - ä¿®æ”¹é‡‘é¢æŒ‰é’®ç‹¬ç«‹åœ¨ `order-actions` ä¸­ï¼Œä¸è§¦å‘äº‹ä»¶å†’æ³¡

2. **ä¼˜åŒ–CSSæ ·å¼**: 
   - è®¢å•å†…å®¹åŒºåŸŸä¿æŒåŸæœ‰æ ·å¼
   - æ“ä½œæŒ‰é’®åŒºåŸŸç‹¬ç«‹æ˜¾ç¤ºï¼Œå¸¦æœ‰èƒŒæ™¯è‰²å’Œè¾¹æ¡†

3. **ç®€åŒ–JavaScript**: ç§»é™¤ä¸å¿…è¦çš„äº‹ä»¶é˜»æ­¢ä»£ç 

**ä¿®å¤æ•ˆæœ**: 
- âœ… ç‚¹å‡»è®¢å•å†…å®¹åŒºåŸŸæ­£å¸¸è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
- âœ… ç‚¹å‡»ä¿®æ”¹é‡‘é¢æŒ‰é’®åªæ‰§è¡Œä¿®æ”¹åŠŸèƒ½ï¼Œä¸è·³è½¬é¡µé¢
- âœ… ä¸¤ä¸ªåŠŸèƒ½å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
- âœ… å¼¹çª—ç•Œé¢ç®€æ´ï¼Œåªæ˜¾ç¤ºè¾“å…¥æ¡†

### APIè°ƒç”¨å‚æ•°é—®é¢˜ä¿®å¤
**é—®é¢˜æè¿°**: è°ƒç”¨ä¿®æ”¹è®¢å•é‡‘é¢APIæ—¶å‡ºç°"ç¼ºå°‘adminUserIdå‚æ•°"é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. **ä¿®å¤app.jsä¸­çš„callContaineræ–¹æ³•**: æ·»åŠ æŸ¥è¯¢å‚æ•°å¤„ç†é€»è¾‘
   - æ”¯æŒé€šè¿‡options.queryä¼ é€’æŸ¥è¯¢å‚æ•°
   - è‡ªåŠ¨æ„å»ºæ­£ç¡®çš„URLæŸ¥è¯¢å­—ç¬¦ä¸²
   - å…¼å®¹å¾®ä¿¡å°ç¨‹åºç¯å¢ƒï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•æ›¿ä»£URLSearchParams

2. **ä¿®æ”¹APIè°ƒç”¨æ–¹å¼**: ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ ¼å¼
   ```javascript
   // ä¿®å¤å‰
   app.callContainer('/api/admin/order/update-amount', 'POST', data, {
     adminUserId: adminInfo.userId
   })
   
   // ä¿®å¤å
   app.callContainer('/api/admin/order/update-amount', 'POST', data, {
     query: { adminUserId: adminInfo.userId }
   })
   ```

3. **ç»Ÿä¸€æ‰€æœ‰ç®¡ç†å‘˜APIè°ƒç”¨**: ç¡®ä¿æ‰€æœ‰ç®¡ç†å‘˜ç›¸å…³APIéƒ½ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ ¼å¼

4. **å…¼å®¹æ€§ä¿®å¤**: ç§»é™¤URLSearchParamsä¾èµ–ï¼Œä½¿ç”¨åŸç”ŸJavaScriptæ–¹æ³•
   ```javascript
   // ä¿®å¤å‰ï¼ˆä¸å…¼å®¹å¾®ä¿¡å°ç¨‹åºï¼‰
   const queryParams = new URLSearchParams()
   queryParams.append(key, value)
   const queryString = queryParams.toString()
   
   // ä¿®å¤åï¼ˆå…¼å®¹å¾®ä¿¡å°ç¨‹åºï¼‰
   const queryParams = []
   queryParams.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
   const queryString = queryParams.join('&')
   ```

**ä¿®å¤æ•ˆæœ**: 
- âœ… ä¿®æ”¹è®¢å•é‡‘é¢APIè°ƒç”¨æˆåŠŸ
- âœ… è·å–è®¢å•åˆ—è¡¨APIè°ƒç”¨æˆåŠŸ
- âœ… æ‰€æœ‰ç®¡ç†å‘˜APIå‚æ•°ä¼ é€’æ­£ç¡®
- âœ… é”™è¯¯ä¿¡æ¯æ›´å‡†ç¡®ï¼Œä¾¿äºè°ƒè¯•
- âœ… å…¼å®¹å¾®ä¿¡å°ç¨‹åºç¯å¢ƒï¼Œç§»é™¤URLSearchParamsä¾èµ–

## ğŸ“ éƒ¨ç½²æ”¯æŒ

å¦‚éœ€éƒ¨ç½²æ”¯æŒï¼Œè¯·ï¼š
1. é‡å¯åç«¯æœåŠ¡
2. ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·æµ‹è¯•
3. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
4. åœ¨å‰ç«¯æµ‹è¯•ä¿®æ”¹æµç¨‹ 