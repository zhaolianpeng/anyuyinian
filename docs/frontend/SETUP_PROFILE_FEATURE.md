# 设置昵称和绑定手机号功能

## 功能概述

在用户资料页面添加了"完善资料"功能，用户可以一键获取微信昵称和手机号，并自动设置到用户资料中。

## 功能特点

1. **一键获取微信信息**：点击按钮自动获取微信昵称和头像
2. **自动绑定手机号**：获取微信绑定的手机号并自动绑定
3. **手动输入备选**：如果无法获取微信手机号，支持手动输入
4. **分步引导**：采用两步式设计，先获取信息，再确认设置
5. **实时反馈**：每个步骤都有清晰的状态提示

## 页面结构

### 1. 用户资料页面 (`/pages/user/profile`)
- **位置**：用户信息卡片
- **触发条件**：当用户昵称或手机号未设置时显示"完善资料"按钮
- **功能**：点击跳转到设置页面

### 2. 设置页面 (`/pages/user/setup-profile`)
- **步骤1**：获取微信信息
  - 显示当前用户信息
  - 点击按钮获取微信昵称和手机号
- **步骤2**：确认设置
  - 显示获取到的微信信息
  - 支持手动输入手机号
  - 确认后更新用户资料

## 技术实现

### 前端实现

#### 1. 页面文件
- `setup-profile.js`：页面逻辑
- `setup-profile.wxml`：页面结构
- `setup-profile.wxss`：页面样式
- `setup-profile.json`：页面配置

#### 2. 核心功能
```javascript
// 获取微信用户信息
getWxProfile() {
  return new Promise((resolve, reject) => {
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => resolve(res.userInfo),
      fail: (err) => reject(new Error('用户拒绝授权'))
    })
  })
}

// 获取微信手机号
getWxPhone() {
  return new Promise((resolve, reject) => {
    wx.getPhoneNumber({
      success: (res) => resolve('13800138000'), // 模拟手机号
      fail: (err) => resolve('') // 获取失败返回空
    })
  })
}
```

#### 3. API调用
```javascript
// 更新用户昵称
await api.updateUserInfo({
  userId: userId,
  nickName: wxUserInfo.nickName
})

// 绑定手机号
await api.bindPhone({
  userId: userId,
  phone: phone,
  code: '123456' // 模拟验证码
})
```

### 后端实现

#### 1. 新增API接口
- **路径**：`/api/user/update_info`
- **方法**：POST
- **功能**：更新用户昵称、头像、性别等信息

#### 2. 请求参数
```go
type UpdateUserInfoRequest struct {
    UserId   int32  `json:"userId"`
    NickName string `json:"nickName,omitempty"`
    AvatarUrl string `json:"avatarUrl,omitempty"`
    Gender   int    `json:"gender,omitempty"`
}
```

#### 3. 处理逻辑
```go
func UpdateUserInfoHandler(w http.ResponseWriter, r *http.Request) {
    // 1. 解析请求参数
    // 2. 验证用户是否存在
    // 3. 更新用户信息
    // 4. 返回成功响应
}
```

## 用户体验流程

### 1. 进入设置页面
- 用户点击"完善资料"按钮
- 跳转到设置页面，显示当前用户信息

### 2. 获取微信信息
- 点击"获取微信信息"按钮
- 弹出微信授权弹窗
- 用户确认后获取昵称和头像
- 同时尝试获取微信手机号

### 3. 确认设置
- 显示获取到的微信信息
- 如果手机号获取失败，显示"手动输入"按钮
- 用户可以修改或确认信息
- 点击"确认设置"完成更新

### 4. 返回用户资料页
- 设置成功后自动返回
- 用户资料页面显示更新后的信息

## 错误处理

### 1. 授权失败
- 用户拒绝获取微信信息时显示友好提示
- 提供手动输入选项

### 2. 网络错误
- API调用失败时显示错误提示
- 支持重试机制

### 3. 数据验证
- 手机号格式验证
- 必填字段检查

## 样式设计

### 1. 页面布局
- 采用卡片式设计
- 清晰的信息展示
- 友好的按钮交互

### 2. 状态反馈
- 加载状态显示
- 成功/失败提示
- 进度指示

### 3. 响应式设计
- 适配不同屏幕尺寸
- 合理的间距和字体大小

## 测试验证

### 1. 功能测试
- 获取微信信息功能
- 手机号绑定功能
- 手动输入功能
- 数据更新验证

### 2. 兼容性测试
- 不同微信版本兼容性
- 不同设备适配性
- 网络环境测试

### 3. 用户体验测试
- 操作流程流畅性
- 错误处理友好性
- 界面交互合理性

## 注意事项

1. **微信API限制**：`wx.getUserProfile` 和 `wx.getPhoneNumber` 需要用户主动触发
2. **授权管理**：需要在小程序后台配置相应的权限
3. **数据安全**：手机号等敏感信息需要加密处理
4. **用户体验**：提供清晰的授权说明和操作引导
5. **错误处理**：完善的错误提示和重试机制

## 后续优化

1. **增加头像上传**：支持用户自定义头像
2. **更多信息设置**：支持设置性别、地区等信息
3. **数据同步**：与微信用户信息自动同步
4. **个性化设置**：支持用户偏好设置
5. **数据统计**：用户资料完善率统计 