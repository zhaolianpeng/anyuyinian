# 微信小程序体验版网络错误修复指南

## 问题描述
开发版调试时请求后端正常访问，但上传到小程序云端体验版时提示网络错误。

## 重要提醒

⚠️ **云托管域名仅用于测试环境，不能用于正式环境**

当前配置中的云托管域名 `https://golang-lfwy-176496-6-1353115175.sh.run.tcloudbase.com` 仅用于开发和测试，不能用于正式环境。

## 问题原因分析

### 1. 域名配置问题（最常见）
- 微信小程序体验版对域名白名单要求更严格
- 需要在微信公众平台后台配置合法域名
- **云托管域名不能用于正式环境**

### 2. HTTPS证书问题
- 体验版要求HTTPS证书有效且受信任
- 开发版可能忽略证书问题

### 3. 网络超时问题
- 生产环境网络延迟可能更高
- 需要增加超时时间和重试机制

## 解决方案

### 第一步：部署正式服务器

#### 1.1 服务器部署选项
1. **云服务器部署**（推荐）
   - 购买阿里云、腾讯云等云服务器
   - 部署Go后端服务
   - 配置域名和SSL证书

2. **容器化部署**
   - 使用Docker部署
   - 配置docker-compose

3. **云函数部署**
   - 使用腾讯云函数等Serverless服务

详细部署指南请参考：`miniprogram/docs/DEPLOYMENT_GUIDE.md`

#### 1.2 域名配置
将后端服务部署到正式服务器后，配置您的正式域名：

```javascript
// 在 miniprogram/config.js 中修改
const DOMAINS = {
  [ENV.DEV]: 'https://api.example.com',  // 开发环境域名
  [ENV.PROD]: 'https://api.yourcompany.com'  // 您的正式域名
}
```

### 第二步：微信小程序后台配置

#### 2.1 配置合法域名
在微信公众平台配置以下域名：

**request合法域名：**
```
https://api.yourcompany.com  // 您的正式API域名
```

**uploadFile合法域名：**
```
https://api.yourcompany.com  // 您的正式API域名
```

**downloadFile合法域名：**
```
https://7072-prod-5g94mx7a3d07e78c-1353115175.cos.ap-shanghai.myqcloud.com
```

#### 2.2 配置步骤
1. 登录微信公众平台 (https://mp.weixin.qq.com)
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 在"服务器域名"部分添加上述域名
4. 确保域名使用HTTPS协议
5. 保存配置
6. 等待配置生效（通常几分钟）

### 第三步：代码优化

#### 3.1 增加超时和重试机制
已优化 `miniprogram/utils/request.js`：
- 增加请求超时设置（15秒）
- 添加重试机制（最多3次）
- 改进错误处理和提示

#### 3.2 添加网络状态检测
已创建 `miniprogram/utils/network.js`：
- 检测网络连接状态
- 监听网络变化
- 提供网络错误提示

#### 3.3 优化首页错误处理
已更新 `miniprogram/pages/index/index.js`：
- 添加网络状态检查
- 改进错误提示
- 增加重试功能

### 第四步：测试验证

#### 4.1 开发环境测试
```bash
# 在微信开发者工具中测试
# 确保勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
```

#### 4.2 真机测试
```bash
# 在真机上测试
# 确保域名已配置到小程序后台
```

#### 4.3 网络测试
```bash
# 在浏览器中测试API域名
curl -I https://api.yourcompany.com/api/home/init

# 测试COS域名
curl -I https://7072-prod-5g94mx7a3d07e78c-1353115175.cos.ap-shanghai.myqcloud.com
```

## 常见问题排查

### 1. 域名未配置
**症状**: 提示"url not in domain list"
**解决**: 检查微信小程序后台域名配置

### 2. HTTPS证书问题
**症状**: 提示SSL证书错误
**解决**: 检查服务器SSL证书配置

### 3. 网络超时
**症状**: 请求超时
**解决**: 增加超时时间，添加重试机制

### 4. 防火墙拦截
**症状**: 连接被拒绝
**解决**: 检查服务器防火墙设置

### 5. DNS解析问题
**症状**: 域名无法解析
**解决**: 检查域名DNS解析是否正确

### 6. 云托管域名问题
**症状**: 使用云托管域名在体验版报错
**解决**: 部署到正式服务器，使用正式域名

## 配置检查清单

### 服务器部署
- [ ] 购买云服务器或选择部署方案
- [ ] 部署Go后端服务
- [ ] 配置HTTPS证书
- [ ] 配置域名解析
- [ ] 测试API接口可访问性

### 微信小程序后台配置
- [ ] 登录微信公众平台
- [ ] 进入"开发" -> "开发管理" -> "开发设置"
- [ ] 添加request合法域名
- [ ] 添加uploadFile合法域名
- [ ] 添加downloadFile合法域名
- [ ] 保存配置
- [ ] 等待配置生效

### 代码配置
- [ ] 修改config.js中的域名
- [ ] 更新request.js增加超时和重试
- [ ] 添加网络状态检测
- [ ] 优化错误处理
- [ ] 测试网络错误页面

## 调试步骤

### 1. 检查网络请求
```javascript
// 在首页添加调试代码
console.log('API响应:', res)
console.log('处理后的数据:', processedData)
```

### 2. 检查域名配置
```javascript
// 检查域名是否正确
console.log('API域名:', baseURL)
console.log('COS域名:', cos.bucketDomain)
```

### 3. 检查错误信息
```javascript
// 在request.js中添加详细错误日志
console.error('网络请求失败:', err)
console.error('错误详情:', err.errMsg)
```

## 验证方法

### 1. 开发环境验证
- 在微信开发者工具中测试
- 确保勾选"不校验合法域名"
- 检查控制台是否有错误信息

### 2. 体验版验证
- 上传代码到体验版
- 在真机上测试
- 检查网络请求是否成功

### 3. 网络环境测试
- 在不同网络环境下测试
- 检查WiFi和移动网络
- 测试网络切换时的表现

## 下一步操作

1. **立即操作**：
   - 选择服务器部署方案
   - 部署Go后端服务
   - 配置正式域名和SSL证书

2. **代码优化**：
   - 修改config.js中的域名
   - 部署更新的代码
   - 测试网络错误处理
   - 验证重试机制

3. **测试验证**：
   - 开发环境测试
   - 体验版测试
   - 真机环境测试

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 具体的错误信息
2. 网络请求的详细日志
3. 微信小程序后台域名配置截图
4. 服务器访问日志
5. 正式域名信息

## 总结

通过以上步骤，应该能够解决微信小程序体验版网络错误问题。关键是要确保：
1. **使用正式域名而不是云托管域名**
2. 域名在微信小程序后台正确配置
3. 服务器HTTPS证书有效
4. 代码中有适当的超时和重试机制
5. 提供良好的用户错误提示 